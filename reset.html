<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reset Code - ISN Free WiFi</title>
<style>
:root { --brand-red:#f60000; --translucent-white:rgba(255,255,255,0.73); }
*{box-sizing:border-box;}body{margin:0;font-family:Segoe UI,Arial,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--brand-red);color:#000;padding:40px;}
.panel{background:#fff;padding:56px 60px 64px;border-radius:28px;max-width:640px;width:100%;display:flex;flex-direction:column;gap:30px;box-shadow:0 30px 80px -18px rgba(0,0,0,.45);} 
h1{margin:0;font-size:48px;text-align:center;color:#000;}p{margin:0;text-align:center;font-size:17px;}
.code-box{display:flex;justify-content:center;gap:14px;}
.code-box input{width:70px;padding:18px 0;font-size:34px;text-align:center;letter-spacing:2px;font-weight:600;background:var(--brand-red);color:#fff;border:none;border-radius:12px;box-shadow:0 4px 14px -4px rgba(0,0,0,.4);} 
button{align-self:center;background:var(--brand-red);color:#fff;border:none;border-radius:40px;padding:16px 56px 18px;font-size:22px;font-weight:700;cursor:pointer;box-shadow:0 10px 28px -6px rgba(0,0,0,.5);}
button:hover{background:#ff2626;}
.notice{font-size:14px;text-align:center;}
@media (max-width:700px){ .panel{padding:48px 40px 54px;} h1{font-size:42px;} .code-box input{width:60px;font-size:30px;} button{padding:16px 46px 18px;font-size:20px;} }
@media (max-width:520px){ .panel{padding:46px 34px 52px;} h1{font-size:38px;} .code-box input{width:52px;font-size:26px;} }
</style>
</head>
<body>
  <div class="panel">
    <h1>Enter Code</h1>
    <p>We sent a 6-digit code to <strong id="emailTarget"></strong>. Enter it below to finish resetting your password.</p>
    <div class="code-box" id="codeBox"></div>
  <button onclick="finishReset()">Save</button>
  <div id="successMsg" class="notice" style="display:none;font-weight:600;color:#000;">Password saved successfully. Redirecting to log in...</div>
    <p class="notice" id="demoCode"></p>
    <p class="notice"><a href="login.html" style="color:#000;font-weight:600;text-decoration:none;">Back to login</a></p>
  </div>
<script>
(function init(){
  const email=sessionStorage.getItem('pendingResetEmail');
  const code=sessionStorage.getItem('pendingResetCode');
  if(!email||!code){ window.location.href='login.html'; return; }
  document.getElementById('emailTarget').textContent=email;
  document.getElementById('demoCode').textContent='(Demo code: '+code+')';
  const box=document.getElementById('codeBox');
  for(let i=0;i<6;i++){ const inp=document.createElement('input'); inp.maxLength=1; inp.inputMode='numeric'; inp.addEventListener('input',()=>{ if(inp.value.length===1){ const next=inp.nextElementSibling; if(next) next.focus(); } }); inp.addEventListener('keydown',e=>{ if(e.key==='Backspace'&&!inp.value){ const prev=inp.previousElementSibling; if(prev){ prev.focus(); prev.value=''; } } }); box.appendChild(inp); }
  box.firstChild.focus();
})();
async function finishReset(){
  const email=sessionStorage.getItem('pendingResetEmail');
  const code=sessionStorage.getItem('pendingResetCode');
  const newPass=sessionStorage.getItem('pendingResetNewPass');
  const entered=Array.from(document.querySelectorAll('#codeBox input')).map(i=>i.value).join('');
  if(entered.length!==6){ alert('Enter all 6 digits'); return; }
  if(entered!==code){ alert('Invalid code (demo)'); return; }
  try{
    const res=await fetch('/api/forgot/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,code, newPassword:newPass})});
    const data=await res.json();
    if(res.ok && data.ok){ 
      const msg=document.getElementById('successMsg');
      msg.style.display='block';
      sessionStorage.removeItem('pendingResetEmail'); sessionStorage.removeItem('pendingResetCode'); sessionStorage.removeItem('pendingResetNewPass');
      setTimeout(()=>window.location.href='login.html',1800);
    }
    else { alert(data.message||'Reset failed'); }
  }catch{ alert('Network error'); }
}
</script>
</body>
</html>
